# syntax=docker/dockerfile:1.7
# ===================================================================================
# Dockerfile.slim â€” small dev & queue images (with 'sail' user)
# Multi-stage; builds extensions once, reuses in small runtime.
# ===================================================================================

FROM php:8.1-fpm-alpine AS base
LABEL maintainer="Mark Gregory <mark.gregory@pba.co.uk>"
ENV COMPOSER_MEMORY_LIMIT=-1

# Create 'sail' user/group (defaults avoid common collisions inside Alpine)
# Override at build: --build-arg PUID=501 --build-arg PGID=1000
ARG PUID=1000
ARG PGID=1000
RUN set -eux; \
  # create group (fallback if PGID already exists)
  if awk -F: -v gid="${PGID}" '$3==gid{f=1} END{exit !(f)}' /etc/group; then \
    addgroup -S sail; \
  else \
    addgroup -g "${PGID}" sail; \
  fi; \
  # create user (bind to requested UID if free)
  if awk -F: -v uid="${PUID}" '$3==uid{f=1} END{exit !(f)}' /etc/passwd; then \
    adduser -D -s /bin/sh -G sail sail || true; \
  else \
    adduser -D -s /bin/sh -u "${PUID}" -G sail sail; \
  fi; \
  mkdir -p /home/sail && chown -R "${PUID}":sail /home/sail
ENV HOME=/home/sail

# Runtime libs only
RUN apk add --no-cache \
    tzdata bash unzip git openssh shadow supervisor \
    icu-libs libzip \
    libpng libjpeg-turbo freetype \
    libxml2 gmp

# Ensure app dir exists and owned by sail
RUN mkdir -p /var/www/html && chown -R sail:sail /var/www/html

# Optional repo INIs
COPY docker/php-fpm/opcache.ini  /usr/local/etc/php/conf.d/zz-opcache.ini
COPY docker/php-fpm/laravel.ini  /usr/local/etc/php/conf.d/zz-laravel.ini

# ---------- Build: compile PHP extensions ----------
FROM base AS build
RUN apk add --no-cache --virtual .build-deps \
      $PHPIZE_DEPS build-base autoconf pkgconf re2c linux-headers \
      icu-dev libzip-dev zlib-dev \
      libpng-dev libjpeg-turbo-dev freetype-dev \
      libxml2-dev gmp-dev \
  && docker-php-ext-configure gd --with-freetype --with-jpeg \
  && docker-php-ext-install -j"$(nproc)" \
       gd exif pcntl zip pdo_mysql bcmath intl gmp opcache \
  && pecl install redis xdebug \
  && docker-php-ext-enable redis \
  && apk del .build-deps

# ---------- runtime-dev: FINAL STAGE (what compose targets) ----------
FROM base AS runtime-dev
WORKDIR /var/www/html

# Bring compiled extensions AND enabling INIs (no hardcoded ext dir)
COPY --from=build /usr/local/lib/php/extensions/ /usr/local/lib/php/extensions/
COPY --from=build /usr/local/etc/php/conf.d/ /usr/local/etc/php/conf.d/

# Composer (from official image)
COPY --from=composer:2 /usr/bin/composer /usr/local/bin/composer
ENV COMPOSER_ALLOW_SUPERUSER=1

# Git safe dirs for local packages
RUN git config --global --add safe.directory /var/www/html || true \
 && git config --global --add safe.directory /var/www/html/packages || true

# Xdebug: opt-in (OFF by default). Enable with: -e XDEBUG_MODE=develop,debug
RUN set -eux; \
  rm -f /usr/local/etc/php/conf.d/*xdebug*.ini || true; \
  EXTDIR="$(php -r "echo ini_get('extension_dir');")"; \
  { \
    echo "zend_extension=${EXTDIR}/xdebug.so"; \
    echo 'xdebug.mode=${XDEBUG_MODE:-off}'; \
    echo 'xdebug.discover_client_host=0'; \
    echo 'xdebug.client_host=host.docker.internal'; \
    echo 'xdebug.client_port=9003'; \
  } > /usr/local/etc/php/conf.d/zz-xdebug.ini

# Make PHP-FPM pool run as 'sail'
RUN sed -i -E 's/^(user|group)\s*=.*/\1 = sail/g' /usr/local/etc/php-fpm.d/www.conf \
 && sed -i -E 's@^;?listen\.owner\s*=.*@listen.owner = sail@g' /usr/local/etc/php-fpm.d/www.conf \
 && sed -i -E 's@^;?listen\.group\s*=.*@listen.group = sail@g' /usr/local/etc/php-fpm.d/www.conf

# Supervisor (php-fpm + queue)
RUN mkdir -p /etc/supervisor/conf.d /var/log/supervisor \
 && printf "%s\n" \
"[supervisord]" \
"nodaemon=true" \
"logfile=/var/log/supervisor/supervisord.log" \
"pidfile=/var/run/supervisord.pid" \
"" \
"[include]" \
"files=/etc/supervisor/conf.d/*.conf" \
 > /etc/supervisord.conf \
 && printf "%s\n" \
"[program:php-fpm]" \
"command=php-fpm --nodaemonize" \
"autostart=true" \
"autorestart=true" \
"stopsignal=QUIT" \
"redirect_stderr=true" \
"stdout_logfile=/var/log/supervisor/php-fpm.log" \
 > /etc/supervisor/conf.d/php-fpm.conf \
 && printf "%s\n" \
"[program:laravel-queue]" \
"directory=/var/www/html" \
"command=php artisan queue:work --verbose --tries=3 --timeout=90" \
"autostart=true" \
"autorestart=true" \
"user=sail" \
"numprocs=1" \
"redirect_stderr=true" \
"stdout_logfile=/var/log/supervisor/worker.log" \
 > /etc/supervisor/conf.d/laravel-worker.conf \
 && chown -R sail:sail /var/log/supervisor

# Init: fix perms + seed vendor if empty (first run)
RUN cat > /usr/local/bin/laravel-init <<'EOF' \
 && chmod +x /usr/local/bin/laravel-init
#!/bin/sh
set -e
cd /var/www/html || exit 1
mkdir -p bootstrap/cache storage/framework/{cache,sessions,views}
chown -R sail:sail storage bootstrap || true
chmod -R ug+rwX storage bootstrap || true
if [ ! -f vendor/autoload.php ] && [ -f composer.json ]; then
  echo "ðŸ“¦ vendor empty â†’ composer install (dev)â€¦"
  composer install --no-interaction --prefer-dist || true
fi
exec "$@"
EOF

# (Optional) warm vendor for dev image (hidden by named volume at runtime)
COPY composer.json composer.lock ./
# REMOVE next line if you don't have a local packages/ dir
COPY packages/ packages/
RUN composer install --no-interaction --prefer-dist --optimize-autoloader --no-scripts || true

# Minimal app copy for dev image (bind mount overrides at runtime)
COPY artisan ./
COPY app/ app/
COPY bootstrap/ bootstrap/
COPY config/ config/
COPY database/ database/
COPY public/ public/
COPY resources/ resources/
COPY routes/ routes/

ENTRYPOINT ["/usr/local/bin/laravel-init"]
CMD ["supervisord","-c","/etc/supervisord.conf"]

EXPOSE 9000 9003
